<ng-container *ngIf="mode === 'GROUP'">
  <label for="groupName" style="font-weight: bold;" >Co-Constraint Group Name : </label>
  <input *ngIf="!delta || !value.nameDelta" [disabled]="vOnly" name="groupName" type="text" class="form-control" style="margin-bottom: 5px;" [(ngModel)]="value.name" (ngModelChange)="emitChange()" >
  <app-delta-column
    *ngIf="delta && !!value.nameDelta"
    [currentValue]="value.nameDelta.current"
    [previousValue]="value.nameDelta.previous"
    [action]="value.nameDelta.delta">
    <ng-template #default let-value>
      {{value}}
    </ng-template>
  </app-delta-column>
  <label style="font-weight: bold;" >Table : </label>
</ng-container>
<form #tableForm="ngForm" >

  <table *ngIf="value" class="table table-bordered table-striped table-sm">
    <thead>
      <tr>
        <th rowspan="2" style="width: 54px;" class="stick-header stick-top-none" *ngIf="!vOnly && !delta">
          <button *ngIf="!vOnly" class="btn btn-sm btn-primary" (click)="addCoConstraint(value.coConstraints)">
            <i class="fa fa-plus"></i>
          </button>
        </th>
        <th rowspan="2" class="requirement-cell stick-header stick-top-none">ID</th>
        <th rowspan="2" class="requirement-cell stick-header stick-top-none">Usage</th>
        <th rowspan="2" class="requirement-cell column-border stick-header stick-top-none">Cardinality</th>
        <ng-container *ngTemplateOutlet="columnHeader; context: { $implicit: 'If', list: value.headers.selectors, isDataHeader: true, selector: true }"></ng-container>
        <ng-container *ngTemplateOutlet="columnHeader; context: { $implicit: 'Then', list: value.headers.constraints, isDataHeader: true  }"></ng-container>
        <th class="column-border stick-header stick-top-none" style="vertical-align: middle; text-align: center;">Group By</th>
        <ng-container *ngTemplateOutlet="columnHeader; context: { $implicit: 'Narratives', list: value.headers.narratives, isDataHeader: false  }"></ng-container>
      </tr>
      <tr>
        <ng-container *ngTemplateOutlet="value.headers.selectors.length > 0 ? columns : emptyColumn; context: { $implicit: value.headers.selectors, template: dataHeader }"></ng-container>
        <ng-container *ngTemplateOutlet="value.headers.constraints.length > 0 ? columns : emptyColumn; context: { $implicit: value.headers.constraints, template: dataHeader }"></ng-container>
        <th class="column column-border stick-header stick-top-none">
          <div *ngIf="!delta" style="width: 100%; display: flex; justify-content: space-between;">
            <div>
              <button *ngIf="!vOnly && mode !== 'GROUP' && value.headers.grouper && (!value.groups || value.groups.length === 0)" (click)="clearGrouper()" class="btn btn-sm btn-danger"><i class="fa fa-times"></i></button>
              <button *ngIf="!vOnly && (mode === 'GROUP' || (value.groups && value.groups.length > 0))" class="btn btn-sm btn-primary" (click)="setTableGrouper(false)"><i class="fa fa-pencil"></i></button>
            </div>
            <div style="width: 100%; text-align: center;" *ngIf="value.headers.grouper" >
              <span class="badge badge-secondary"> Group Id </span>
              <app-entity-bagde [type]="value.headers.grouper.type"></app-entity-bagde>
              <span style="margin-left: 3px;">{{value.headers.grouper.name}}</span>
            </div>
          </div>
          <app-delta-column
              *ngIf="delta && value.headers.grouper"
              [currentValue]="{ name : value.headers.grouper.nameDelta.current, type : value.headers.grouper.typeDelta.current }"
              [previousValue]="{ name : value.headers.grouper.nameDelta.previous, type : value.headers.grouper.typeDelta.previous }"
              [action]="value.headers.grouper.delta">
            <ng-template #default let-value>
              <div style="width: 100%; text-align: center;">
                <span class="badge badge-secondary"> Group Id </span>
                <app-entity-bagde [type]="value.type"></app-entity-bagde>
                <span style="margin-left: 3px;">{{value.name}}</span>
              </div>
            </ng-template>
          </app-delta-column>
        </th>
        <ng-container *ngTemplateOutlet="value.headers.narratives.length > 0 ? columns : emptyColumn; context: { $implicit: value.headers.narratives, template: narrativeHeader }"></ng-container>
      </tr>
    </thead>
    <ng-container *ngTemplateOutlet="ccList; context: { $implicit: value.coConstraints, group : mode === 'GROUP', fieldId : 'ind', viewOnly: vOnly }"></ng-container>
    <ng-container *ngFor="let group of value.groups; let i = index">
      <ng-container [ngSwitch]="group.type" >
        <ng-container *ngSwitchCase="'REF'">
          <ng-container *ngTemplateOutlet="ccGroupRef; context: { $implicit: group, list : value.groups, index: i, viewOnly: vOnly }"></ng-container>
        </ng-container>
        <ng-container *ngSwitchCase="'CONTAINED'">
          <ng-container *ngTemplateOutlet="ccGroup; context: { $implicit: group, list : value.groups, index: i, viewOnly: vOnly }"></ng-container>
        </ng-container>
      </ng-container>
    </ng-container>
  </table>

  <!-- COLUMNS TOP HEADER -->
  <ng-template #columnHeader let-selector="selector" let-label let-list="list" let-isDataHeader="isDataHeader">
    <th [attr.colspan]="listSize(list)" class="column-border stick-header stick-top-none">
      <div style="display: flex; justify-content: space-between;">
        <span>{{label}}</span>
        <button *ngIf="!vOnly" class="btn btn-sm btn-primary" (click)="isDataHeader ? openDataColumnDialog(list, selector) : openNarrativeColumnDialog(list)">
          <i class="fa fa-plus"></i>
        </button>
      </div>
    </th>
  </ng-template>

  <!-- COLUMNS DYNAMIC COLLUMN -->
  <ng-template #columns let-list let-template="template">
    <ng-container *ngFor="let header of list; let i = index">
        <ng-container *ngTemplateOutlet="template; context: { $implicit: header, list: list, index : i }"></ng-container>
    </ng-container>
  </ng-template>

  <!-- EMPTY COLUMN -->
  <ng-template #emptyColumn>
    <th class="column empty-column column-border stick-header stick-top-pad"></th>
  </ng-template>

  <!-- DATA HEADER -->
  <ng-template #dataHeader let-header let-list="list" let-index="index">
    <th class="column stick-header stick-top-pad" [ngClass]="{'column-border': index === (list.length - 1) && !header.cardinality, 'inside-border' :  index !== (list.length - 1) && !header.cardinality }">
      <div style="width: 100%; display: flex; justify-content: space-between;">
        <div *ngIf="!header._keep">
          <button *ngIf="!vOnly" class="btn btn-sm btn-danger" (click)="deleteColumn(list, header, index)"><i class="fa fa-times"></i></button>
        </div>
        <div style="width: 100%; text-align: center;">
          <span class="badge badge-secondary">{{header.columnType}}</span>
          <app-entity-bagde [type]="header.elementInfo.type"></app-entity-bagde>
          <span style="margin-left: 3px;">{{header.name}}</span>
        </div>
      </div>
    </th>
    <th *ngIf="header.cardinality" style="text-align: center; vertical-align: middle; width: 60px;" class="stick-header stick-top-pad" [ngClass]="{'column-border': index === (list.length - 1), 'inside-border' : index !== (list.length - 1) }">
      Cardinality
    </th>
  </ng-template>

  <!-- NARRATIVE HEADER -->
  <ng-template #narrativeHeader let-header let-list="list" let-index="index">
    <th class="column" [ngClass]="{'column-border': index === (list.length - 1)}">
      <div style="width: 100%; text-align: center; display: flex;  align-items: center; justify-content: space-between;" >
        <button *ngIf="!header._keep && !vOnly" class="btn btn-sm btn-danger" (click)="deleteColumn(list, header, index)"><i class="fa fa-times"></i></button>
        <div style="width: 100%; text-align: center;" >
          <span class="badge badge-secondary">TEXT</span>
          <span style="margin-left: 3px;">{{header.title}}</span>
        </div>
      </div>
    </th>
  </ng-template>

  <!-- REQUIREMENTS -->
  <ng-template #usage let-usageDelta="usageDelta" let-elm let-disabled="disabled" let-fieldId="fieldId" let-viewOnly="viewOnly" >
    <!-- {{usages | json}} -->
    <div style="width: 60px;">
      <app-ngx-dropdown
        *ngIf="!viewOnly && !delta"
        [(ngModel)]="elm.usage"
        [name]="fieldId + '-usage'"
        [disabled]="disabled"
        (ngModelChange)="usageChange($event, elm)"
        [required]="true"
        [values]="usages">
      </app-ngx-dropdown>
    </div>

    <strong *ngIf="viewOnly && (!delta || !usageDelta)">{{elm.usage}}</strong>

    <app-delta-column
        *ngIf="delta && !!usageDelta"
        [currentValue]="usageDelta.current"
        [previousValue]="usageDelta.previous"
        [action]="usageDelta.delta">
      <ng-template #default let-value>
        {{value}}
      </ng-template>
    </app-delta-column>
  </ng-template>

  <ng-template #cardinality let-cardinalityDelta="cardinalityDelta" let-elm let-fieldId="fieldId" let-viewOnly="viewOnly" >
    <div style="width : 100%; display: flex;" *ngIf="!viewOnly && !delta">
      <input
        style="width: 50px;"
        type="number"
        [(ngModel)]="elm.cardinality.min"
        [name]="fieldId + '-min'"
        (ngModelChange)="emitChange()"
        class="form-control"
        required >
      <input
        style="width: 50px;"
        type="text"
        [(ngModel)]="elm.cardinality.max"
        [name]="fieldId + '-max'"
        (ngModelChange)="emitChange()"
        class="form-control"
        required >
    </div>
    <div style="width : 100%;" *ngIf="viewOnly && (!delta || !cardinalityDelta)">
      <strong>{{elm.cardinality.min}}</strong>
      <span>..</span>
      <strong>{{elm.cardinality.max}}</strong>
    </div>
    <app-delta-column
      *ngIf="delta && !!cardinalityDelta"
      [currentValue]="cardinalityDelta.current"
      [previousValue]="cardinalityDelta.previous"
      [action]="cardinalityDelta.delta">
        <ng-template #default let-value>
          <div style="width : 100%;">
            <strong>{{value.min}}</strong>
            <span>..</span>
            <strong>{{value.max}}</strong>
          </div>
        </ng-template>
    </app-delta-column>
  </ng-template>

  <!-- STRUCTURE -->
  <ng-template #ccList let-list let-group="group" let-fieldId="fieldId" let-viewOnly="viewOnly" let-deltaBody="deltaBody" >
    <tbody cdkDropList [cdkDropListData]="list" (cdkDropListDropped)="drop($event)" [ngClass]="{
      'row-added': delta && deltaBody === 'ADDED',
      'row-deleted': delta && deltaBody === 'DELETED',
      'row-changed': delta && deltaBody === 'CHANGED'
    }">
      <tr *ngFor="let cc of list; let i = index" cdkDrag [cdkDragDisabled]="viewOnly"
      [ngClass]="{
        'row-added': delta && cc.delta === 'ADDED',
        'row-deleted': delta && cc.delta === 'DELETED',
        'row-changed': delta && cc.delta === 'CHANGED'
      }"
      >
        <div *cdkDragPreview style="padding: 10px; background-color: lightcoral;"> Co-Constraint ({{ i + 1 }}) </div>
        <td class="btn-cell" *ngIf="!vOnly && !delta" ><button *ngIf="!viewOnly" class="btn btn-sm btn-danger" (click)="deleteCoConstraint(list, i)"><i class="fa fa-times"></i></button></td>
        <td class="requirement-cell" style="text-align: center;">
          <table style="width: 100%;">
            <tr *ngIf="delta && cc.delta === 'ADDED'" class="table-success">
              <td> ADDED </td>
            </tr>
            <tr *ngIf="delta && cc.delta === 'DELETED'" class="table-removed">
              <td> DELETED </td>
            </tr>
            <tr *ngIf="delta && cc.delta === 'CHANGED'" class="table-warning">
              <td> CHANGED </td>
            </tr>
            <tr *ngIf="i === 0 && group" class="table-primary">
              <td> PRIMARY </td>
            </tr>
            <tr *ngIf="cc.cloned && derived" class="table-info">
              <td> DERIVED </td>
            </tr>
            <tr>
              <td>{{i + 1}}</td>
            </tr>
          </table>
        </td>
        <td class="requirement-cell"><ng-container *ngTemplateOutlet="usage; context: { $implicit: cc.requirement, usageDelta: cc.requirement.usageDelta, disabled :  i === 0 && group, fieldId : fieldId + '-req-' + i, viewOnly : viewOnly || vOnly }"></ng-container></td>
        <td class="requirement-cell column-border"><ng-container *ngTemplateOutlet="cardinality; context: { $implicit: cc.requirement, cardinalityDelta: cc.requirement.cardinalityDelta, fieldId : fieldId + '-req-' + i, viewOnly : viewOnly || vOnly }"></ng-container></td>
        <ng-container *ngTemplateOutlet="cellList; context: { $implicit: cc, headers: value.headers.selectors, fieldId : fieldId + '-if-' + i, viewOnly : viewOnly || vOnly || (cc.cloned && derived), excludeBindingStrength: true, column:'selectors'}"></ng-container>
        <ng-container *ngTemplateOutlet="cellList; context: { $implicit: cc, headers: value.headers.constraints, fieldId : fieldId + '-then-' + i, viewOnly : viewOnly || vOnly || (cc.cloned && derived), column:'constraints' }"></ng-container>
        <td class="column-border" style="vertical-align: middle; text-align: center; font-weight: bold;">
          <span *ngIf="value.headers.grouper"> {{ group ? 'Same Within Group' : 'Distinct'}}</span>
        </td>
        <ng-container *ngTemplateOutlet="cellList; context: { $implicit: cc, headers: value.headers.narratives, fieldId : fieldId + '-nar-' + i, viewOnly : viewOnly || vOnly || (cc.cloned && derived), column:'narratives'}"></ng-container>
      </tr>
    </tbody>
  </ng-template>

  <!-- STRUCTURE -->
  <ng-template #ccGroup let-group let-list="list" let-index="index" let-viewOnly="viewOnly">
    <tbody>
      <tr style="background-color: gray;" [ngClass]="{
        'row-added': delta && group.delta === 'ADDED',
        'row-deleted': delta && group.delta === 'DELETED',
        'row-changed': delta && group.delta === 'CHANGED'
      }">
        <td class="btn-cell" colspan="2" *ngIf="!vOnly && !delta">
          <button *ngIf="!viewOnly" class="btn btn-sm btn-primary" (click)="addCoConstraint(group.coConstraints)">
            <i class="fa fa-plus"></i>
          </button>
          <button *ngIf="!viewOnly" class="btn btn-sm btn-danger" (click)="deleteCoConstraintGroup(list, index)"><i class="fa fa-minus"></i></button>
        </td>
        <td *ngIf="vOnly || delta" >
          <table style="width: 100%;" *ngIf="delta">
            <tr *ngIf="delta && group.delta === 'ADDED'" class="table-success">
              <td class="table-success"> ADDED </td>
            </tr>
            <tr *ngIf="delta && group.delta === 'DELETED'" class="table-removed">
              <td> DELETED </td>
            </tr>
            <tr *ngIf="delta && group.delta === 'CHANGED'" class="table-warning">
              <td> CHANGED </td>
            </tr>
          </table>
        </td>
        <td class="requirement-cell"><ng-container *ngTemplateOutlet="usage; context: { $implicit: group.requirement, usageDelta: group.requirement.usageDelta, fieldId : 'g-' + index, viewOnly: viewOnly  }"></ng-container></td>
        <td class="requirement-cell column-border"><ng-container *ngTemplateOutlet="cardinality; context: { $implicit: group.requirement, cardinalityDelta: group.requirement.cardinalityDelta, fieldId : 'g-' + index, viewOnly: viewOnly  }"></ng-container></td>
        <td [attr.colspan]="numberOfColumns()" style="vertical-align: middle;">
          <input style="background-color: #f4f4f4;" *ngIf="!delta || !group.nameDelta"  [disabled]="viewOnly" class="form-control" type="text" [name]="'g-' + index + '-name'" [(ngModel)]="group.name" (ngModelChange)="emitChange()" placeholder="Group Name">
          <app-delta-column
            *ngIf="delta && !!group.nameDelta"
            [currentValue]="group.nameDelta.current"
            [previousValue]="group.nameDelta.previous"
            [action]="group.nameDelta.delta">
            <ng-template #default let-value>
              {{value}}
            </ng-template>
          </app-delta-column>
        </td>
      </tr>
    </tbody>
    <ng-container *ngTemplateOutlet="ccList; context: { $implicit: group.coConstraints, group : true, fieldId : 'g-' + index, viewOnly: viewOnly, deltaBody: group.delta }"></ng-container>
  </ng-template>

  <ng-template #ccGroupRef let-group let-list="list" let-index="index" let-viewOnly="viewOnly">
    <ng-container *ngIf="groupsMap[group.refId] as content">
      <tbody>
        <tr style="background-color: gray;">
          <td class="btn-cell" colspan="2" *ngIf="!vOnly && !delta">
            <button *ngIf="!viewOnly" class="btn btn-sm btn-danger" (click)="deleteCoConstraintGroup(list, index)"><i class="fa fa-minus"></i></button>
          </td>
          <td *ngIf="vOnly || delta" ></td>
          <td class="requirement-cell"><ng-container *ngTemplateOutlet="usage; context: { $implicit: group.requirement, fieldId : 'g-' + index, viewOnly: viewOnly  }"></ng-container></td>
          <td class="requirement-cell column-border"><ng-container *ngTemplateOutlet="cardinality; context: { $implicit: group.requirement, fieldId : 'g-' + index, viewOnly: viewOnly  }"></ng-container></td>
          <td [attr.colspan]="numberOfColumns()" style="vertical-align: middle;">
            <app-entity-bagde [type]="'COCONSTRAINTGROUP'"></app-entity-bagde>
            <strong style="color: white; margin-left: 5px;">{{ content.name }}</strong>
          </td>
        </tr>
      </tbody>
      <ng-container *ngTemplateOutlet="ccList; context: { $implicit: content.coConstraints, group : true, fieldId : 'g-' + index, viewOnly: true }"></ng-container>
    </ng-container>
  </ng-template>

  <!-- CELLS -->
  <ng-template #cellList let-excludeBindingStrength="excludeBindingStrength" let-headers="headers" let-cc let-fieldId="fieldId" let-viewOnly="viewOnly" let-column="column">
    <ng-container *ngIf="headers.length > 0; else emptyColumn">
      <ng-container *ngFor="let header of headers; let i = index">

        <ng-container [ngSwitch]="!cc.cells[header.key] || (cc.cells[header.key] && (header.columnType === cc.cells[header.key].type || (!header.columnType && cc.cells[header.key].type === 'VALUE')))">

          <ng-container *ngSwitchCase="true">
            <td style="position: relative;" #anchor class="column"  [ngClass]="{'column-border': i === (headers.length - 1) && !header.cardinality, 'inside-border' : i !== (headers.length - 1) && !header.cardinality }" *ngIf="cc.cells[header.key]; else emptyColumn" >
                <ng-container *ngTemplateOutlet="getCellTemplate(header); context: { $implicit: cc.cells[header.key], header: header, id: cc.id, row: cc, fieldId : fieldId + '-' + header.key, viewOnly: viewOnly, anchor: anchor, excludeBindingStrength: excludeBindingStrength, column: column }"></ng-container>
            </td>
            <td *ngIf="header.cardinality" [ngClass]="{'column-border': i === (headers.length - 1), 'inside-border' :  i !== (headers.length - 1) }" style="vertical-align: middle; text-align: center;">
              <input *ngIf="!viewOnly" type="text" style="width: 100px;" [placeholder]="header.elementInfo.cardinality.max" [name]="fieldId + '-cardinality'" [(ngModel)]="cc.cells[header.key].cardinalityMax" (ngModelChange)="emitChange()" >
              <strong *ngIf="viewOnly"> {{ cc.cells[header.key].cardinalityMax || header.elementInfo.cardinality.max }}</strong>
            </td>
          </ng-container>

          <ng-container *ngSwitchCase="false">
            <td #anchor class="column"  [ngClass]="{'column-border': i === (headers.length - 1) && !header.cardinality, 'inside-border' : i !== (headers.length - 1) && !header.cardinality }">
              <span style="color: red">
                Cell type conflicts with header (Header type is {{header.columnType ? header.columnType : 'VALUE'}}, Cell type is {{ cc.cells[header.key].type }})
              </span>
            </td>
          </ng-container>
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-template>

  <!-- CELLS -->
  <ng-template #codeCell let-overrideBindingInfo="overrideBindingInfo" let-header="header" let-cell let-fieldId="fieldId" let-viewOnly="viewOnly" let-anchor="anchor" let-column="column">
    <div style="width: 100%; display: flex; justify-content: space-between;" *ngIf="!viewOnly">
      <input
        type="text"
        [name]="fieldId + '-code'"
        [(ngModel)]="cell.code"
        (ngModelChange)="emitChange()"
        class="form-control"
        placeholder="Code"
        [required]="column==='selectors'"
        style="width: 50%;">
      <input
        type="text"
        [name]="fieldId + '-codeSys'"
        [(ngModel)]="cell.codeSystem"
        (ngModelChange)="emitChange()"
        class="form-control"
        [required]="column==='selectors'"
        placeholder="Code System"
        style="width: 50%;">
    </div>
    <app-ngx-dropdown
      *ngIf="!viewOnly"
      [(ngModel)]="cell.locations"
      placeholder="Binding Locations"
      [name]="fieldId + '-location'"
      (ngModelChange)="emitChange()"
      [required]="column==='selectors'"
      [values]="overrideBindingInfo ? overrideBindingInfo.allowedBindingLocations : header?.elementInfo?.bindingInfo?.allowedBindingLocations">
    </app-ngx-dropdown>

    <div *ngIf="viewOnly" style="width: 100%; display: flex; justify-content: space-between;">
      <table class="table" style="margin-bottom: 0px;">
        <tr>
          <th>Code :</th>
          <td>{{ cell.code }}</td>
        </tr>
        <tr>
          <th>Code System :</th>
          <td>{{ cell.codeSystem }}</td>
        </tr>
        <tr *ngIf="cell.locations">
          <th>Locations :</th>
          <td>{{ cell.locations | json }}</td>
        </tr>
      </table>
    </div>
  </ng-template>

  <ng-template #narrativeCell let-header="header" let-cell let-fieldId="fieldId" let-viewOnly="viewOnly">
    <textarea class="form-control" [(ngModel)]="cell.value" [name]="fieldId + '-textArea'" (ngModelChange)="emitChange()" [disabled]="viewOnly" ></textarea>
  </ng-template>

  <ng-template #datatypeCell let-header="header" let-id="id" let-row="row" let-cell let-fieldId="fieldId" let-viewOnly="viewOnly" let-anchor="anchor" >
    <table class="table table-sm" style="margin-bottom: 0px;">
      <tr>
        <td style="text-align: center; vertical-align: middle; width: 60px;" >
          <strong>Value</strong>
        </td>
        <td>
          <app-ngx-dropdown
          *ngIf="!viewOnly"
          [(ngModel)]="cell.value"
          placeholder="Datatype"
          [name]="fieldId + '-dtValue'"
          (ngModelChange)="datatypeValueChange($event, cell, row)"
          [filter]="true"
          [required]="true"
          [filterFn]="filterDatatypeValue"
          [values]="datatypeOptions">
          </app-ngx-dropdown>
          <span *ngIf="viewOnly"> {{ cell.value }} </span>
        </td>
      </tr>
      <tr *ngIf="cell.value">
        <td style="text-align: center; vertical-align: middle; width: 60px;">
          <strong>Flavor</strong>
        </td>
        <td>
          <div #fl ></div>
          <app-resource-dropdown
            *ngIf="!viewOnly"
            [placeholder]="'Flavor'"
            [name]="fieldId + '-dtFlavor'"
            [filter]="true"
            [filterBy]="cell.value"
            [required]="true"
            [appendTo]="fl"
            [(id)]="cell.datatypeId"
            (valueChange)="datatypeChange($event, row)"
            [resources]="datatypes"
          ></app-resource-dropdown>
          <app-display-section
            *ngIf="viewOnly && getDatatype(cell.datatypeId) as display"
            [element]="display"
            [hideDescription]="true"
          >
          </app-display-section>
        </td>
      </tr>
    </table>
  </ng-template>

  <ng-template #valueSetCell let-overrideBindingInfo="overrideBindingInfo" let-excludeBindingStrength="excludeBindingStrength" let-header="header" let-cell let-viewOnly="viewOnly">
    <div style="width: 100%; display: flex; justify-content: space-between; align-items: start;">
      <div style="margin-right: 5px; width: 100%;">
        <ng-container *ngFor="let item of cell.bindings">
          <ng-container *ngTemplateOutlet="displayVsBinding; context: { $implicit : item, bindingStrength : bindingStrength }"></ng-container>
        </ng-container>
      </div>
      <button *ngIf="!viewOnly" class="btn btn-sm btn-primary" (click)="openVsPicker(cell, header, excludeBindingStrength, overrideBindingInfo)"><i class="fa fa-pencil"></i></button>
    </div>
  </ng-template>

  <ng-template #displayVsBinding let-vsBinding>
    <table class="table table-striped table-sm table-bordered" style="text-align: center; margin-bottom: 0;">
      <tr>
        <td pTooltip="Binding Strength" tooltipPosition="top" *ngIf="vsBinding.strength">
          <strong >{{vsBinding.strength}}</strong>
        </td>
        <td *ngIf="!vsBinding.strength"></td>
        <td pTooltip="Binding Locations" tooltipPosition="top">
          <strong>{{vsBinding.valuesetLocations.length > 0 ? (vsBinding.valuesetLocations | json) : '.'}}</strong>
        </td>
      </tr>
      <tr *ngFor="let itemId of vsBinding.valueSets" >
        <td colspan="2" *ngIf="getVsById(itemId) as item">
          <div [pTooltip]="item.description" tooltipPosition="top" style="display: flex; flex-direction: row; align-items: center;">
            <app-entity-bagde [type]="item.type"></app-entity-bagde>
            <app-scope-badge *ngIf="item.domainInfo" [scope]="item.domainInfo.scope" [version]="item.domainInfo.version"></app-scope-badge>
            <strong *ngIf="item.variableName" style="margin-left: 5px; word-break: break-all;"> {{item.variableName}}</strong>
          </div>
        </td>
      </tr>
    </table>
  </ng-template>

  <ng-template #valueCell let-header="header" let-cell let-fieldId="fieldId" let-viewOnly="viewOnly" let-column="column" >
    <input type="text" [(ngModel)]="cell.value" class="form-control" [name]="fieldId + '-value'" placeholder="Constant Value" (ngModelChange)="emitChange()" *ngIf="!viewOnly" [required]="column==='selectors'">
    <div  *ngIf="viewOnly" style="text-align: center; width: 100%;">
      <span>{{cell.value}}</span>
    </div>
  </ng-template>

  <ng-template #variesCell let-header="header" let-id="id" let-cell let-viewOnly="viewOnly">
    <div class="btn-group" style="width: 100%; border: 1px solid gray;" *ngIf="!viewOnly && !cell.cellType && variesOptionMap[id] && variesOptionMap[id].allowed && variesOptionMap[id].allowed.length > 0">
      <button *ngFor="let item of variesOptionMap[id].allowed" class="btn btn-sm btn-light" (click)="setTemplateType(cell, item)">{{ item }}</button>
    </div>
    <div  style="width: 100%; text-align: center; color: lightgray;" *ngIf="!cell.cellType && (!variesOptionMap[id] || !variesOptionMap[id].allowed || variesOptionMap[id].allowed.length === 0) && !viewOnly">
      <strong>Select OBX-2 datatype (Coded Element or Primitive)</strong>
    </div>
    <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;" *ngIf="cell.cellType">
      <div style="width: 100%;">
        <ng-container *ngTemplateOutlet="getCellTemplateForType(cell.cellType); context: { $implicit: cell.cellValue, header: header, viewOnly : viewOnly, overrideBindingInfo: variesOptionMap[id]?.bindingInfo }"></ng-container>
      </div>
      <i style="color: red; margin-left: 5px; font-size: 1.2em; cursor: pointer;" class="fa fa-times" (click)="clearVariesCell(cell)" *ngIf="!viewOnly" ></i>
    </div>
  </ng-template>

</form>
